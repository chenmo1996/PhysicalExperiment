//to get a SerializeJson method
var ajaxstate = false; //定义全局变量，通过这个变量来获得当前的ajax状态
$(function() {
    $(document).ajaxStart(function() {
        console.log("数据加载中");
    }).ajaxStop(function(evt, request, settings) { //jquery里的全局事件，当ajax请求结束后，改变全局变量的值
        ajaxstate = false;
    });
});
$.ajaxSetup({
    global: true,
    type: "POST",
    cache: false,
    async: true,
    beforeSend: function(e, xhr) {
        if (ajaxstate) {
            console.log("上次请求尚未完成,不能请求" + xhr.url);
            return false;
        }
        ajaxstate = true;
    },
    error: function(a, b, c) {
        console.log(b + ":" + c + "\n\n" + "或者刷新页面");
        jQuery.mobile.changePage("#wrongMsg");
        return false;
    }
});
(function($) {
    $.fn.serializeJson = function() {
        var serializeObj = {};
        $(this.serializeArray()).each(function() {
            serializeObj[this.name] = this.value;
        });
        return JSON.stringify(serializeObj);
    };
})(jQuery);
$(document).bind('pageinit', function() {
    var isAjax = false;
    if (isAjax) {
        return;
    } else {
        $("#exp7 form").on("submit", function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = getAnswers("#exp7", "7", event, isAjax);
            return false;
        });
        $("#exp7 form input.generate").on('click', function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = generateAns("#exp7", "7", event, isAjax);
            return false;
        });

        $("#exp8_1st form").on("submit", function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = getAnswers("#exp8_1st", "8/1", event, isAjax);
            return false;
        });
        $("#exp8_1st form input.generate").on('click', function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = generateAns("#exp8_1st", "8/1", event, isAjax);
            return false;
        });
        $("#exp8_2nd form").on("submit", function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = getAnswers("#exp8_2nd", "8/2", event, isAjax);
            return false;
        });
        $("#exp8_2nd form input.generate").on('click', function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = generateAns("#exp8_2nd", "8/2", event, isAjax);
            return false;
        });
        $("#exp9 form").on("submit", function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = getAnswers("#exp9", "9", event, isAjax);
            return false;
        });
        $("#exp9 form input.generate").on('click', function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = generateAns("#exp9", "9", event, isAjax);
            return false;
        });
        $("#exp10_1st form").on("submit", function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = getAnswers("#exp10_1st", "10/1", event, isAjax);
            return false;
        });
        $("#exp10_1st form input.generate").on('click', function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = generateAns("#exp10_1st", "10/1", event, isAjax);
            return false;
        });
        $("#exp10_2nd form").on("submit", function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = getAnswers("#exp10_2nd", "10/2", event, isAjax);
            return false;
        });
        $("#exp10_2nd form input.generate").on('click', function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = generateAns("#exp10_2nd", "10/2", event, isAjax);
            return false;
        });
        $("#exp11_1st form").on("submit", function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = getAnswers("#exp11_1st", "11/1", event, isAjax);
            return false;
        });
        $("#exp11_1st form input.generate").on('click', function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = generateAns("#exp11_1st", "11/1", event, isAjax);
            return false;
        });
        $("#exp11_2nd form").on("submit", function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = getAnswers("#exp11_2nd", "11/2", event, isAjax);
            return false;
        });
        $("#exp11_2nd form input.generate").on('click', function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = generateAns("#exp11_2nd", "11/2", event, isAjax);
            return false;
        });
        $("#exp12 form").on("submit", function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = getAnswers("#exp12", "12", event, isAjax);
            return false;
        });
        $("#exp12 form input.generate").on('click', function(event) {
            if (isAjax) return;
            event.preventDefault();
            event.stopPropagation();
            isAjax = generateAns("#exp12", "12", event, isAjax);
            return false;
        });
    }


});

function getAnswers(pageID, pageNum, event, isAjax) {
    var _url = '/api/v1/experiment/' + pageNum;
    var submitBtn = pageID + " input:submit";
    var $submitBtn = $(submitBtn);
    var form = pageID + " form";
    var $form = $(form);
    if (isAjax) return;
    isAjax = true;
    $submitBtn.attr("disabled", "disabled");
    event.preventDefault();
    event.stopPropagation();
    // var me = this;
    $.mobile.loading("show");
    var _data = $form.serializeJson();
    $.post(_url, _data, function(data, textStatus) {

            var html = "";
            console.log(data);
            console.log(textStatus);
            var dataJson = JSON.stringify(data);
            JSON.parse(dataJson, function(k, v) {
                if (k === '') return v;
                var li = '<li class="ui-field-contain ui-li-static ui-body-inherit"><label>' + k + ':</label><div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input type="text" name=' + k + ' value=' + v + '></div></li>';
                html += li;
                return false;
            });
            var $answersList = $form.parent().find('.answersList')
            $(html).appendTo($answersList);
            $answersList.listview('refresh');
        }, 'json')
        .success(function() {

            if ($submitBtn.attr("disabled") == false) {
                $submitBtn.attr("disabled", "disabled");
            } else {
                $submitBtn.removeAttr("disabled");
            };

        });
    var errored = false;
    // $(pageID).ajaxError(function(event, xhr, settings, thrownError) {
    //     if (errored) return;
    //     if (thrownError == "Bad Request") {
    //         // var ahref = "<a data-rel=" + pageID + " >重新输入</a>";
    //         // $(ahref).appendTo('#wrongMsg');
    //         // jQuery.mobile.changePage("#wrongMsg");
    //         errored = true;
    //     }
    //     console.log(thrownError);
    //     console.log("hello");
    //     if ($submitBtn.attr("disabled") == false) {
    //         $submitBtn.attr("disabled", "disabled");
    //     } else {
    //         $submitBtn.removeAttr("disabled");
    //     };
    // });
    if ($submitBtn.attr("disabled") == false) {
        $submitBtn.attr("disabled", "disabled");
    } else {
        $submitBtn.removeAttr("disabled");
    };
    isAjax = false;
    $.mobile.loading("hide");
    return isAjax;
}
//pageID is ID    pageNum is attr  
function generateAns(pageID, pageNum, event, isAjax) {
    var _url = '/api/v1/experiment/' + pageNum;
    // var submitBtn = pageID + " input:submit";
    // var $submitBtn = $(submitBtn);
    // var form = pageID + " form";
    // var $form = $(form);
    if (isAjax) return;
    isAjax = true;
    $.mobile.loading("show");
    event.preventDefault();
    event.stopPropagation();
    $.get(_url, function(data) {
        console.log(data);
        console.log(typeof(data));
        var html = "";
        $.each(data, function(key, val) {
            $.each(data[key], function(index, val) {
                data[key][index] = data[key][index].toFixed(2);
                // console.log(data[key][index]);
            });
            console.log(typeof(data[key]));
            if (typeof(data[key]) == "number") {
                var v = data[key];
            } else {
                var v = data[key].join();
            };

            var li = '<li class="ui-field-contain ui-li-static ui-body-inherit"><label>' + key + ':</label><div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input type="text" name=' + key + ' value=' + v + '></div></li>';
            html += li;
        });
        var $answersList = $(pageID).find('.answersList');
        $(html).appendTo($answersList);
        $answersList.listview('refresh');

        return false;
    });
    isAjax = false;
    $.mobile.loading("hide");
    return isAjax;
}